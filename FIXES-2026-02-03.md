# Dashboard Connection & Data Loss Fixes - 2026-02-03

## Summary
Implemented 5 critical fixes to resolve progressive connection and data loss issues in the Bitcoin dashboard.

## Problems Identified

### Issue 1: Request Stacking (CRITICAL)
- `updateCpu()` had no timeout or abort mechanism
- Empty catch block `.catch(() => {})` silently ignored all errors
- Requests stacked up when backend was slow (5s interval with 60s+ response time)
- Browser could accumulate dozens of pending requests

### Issue 2: Subprocess/Connection Exhaustion
- Every RPC call created new subprocess (`subprocess.run()`)
- Every SSH call created new SSH connection (no pooling)
- Failed connections never cleaned up
- System resources (file descriptors, processes) exhausted over time

### Issue 3: Backend Cache Never Expired on Failure
- When RPC calls failed, `run_command()` returned `None`
- Cache retained old values indefinitely with no expiration
- Frontend displayed progressively staler data
- No indication to user that data was outdated

### Issue 4: No Error Visibility
- System stats failures were completely invisible
- Intervals kept running during failures
- User saw "working" dashboard with stale/missing data

### Issue 5: No Backend Health Tracking
- No monitoring of consecutive failures
- No degradation detection
- No user feedback about backend state

---

## Fixes Implemented

### FIX #1: Add Timeout to updateCpu()
**Location:** bitcoin-dashboard.py:1733-1796

**Changes:**
```javascript
// Added AbortController with 15-second timeout
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 15000);

fetch('/api/cpu', { signal: controller.signal })
    .then(r => {
        clearTimeout(timeoutId);
        return r.json();
    })
```

**Benefits:**
- Prevents hanging requests
- Matches timeout behavior of `update()` function
- Requests abort after 15 seconds instead of hanging indefinitely

---

### FIX #2: Request-In-Flight Tracking
**Location:** bitcoin-dashboard.py:1488-1489, 1733-1738, 1852-1857, 2138, 2148

**Changes:**
```javascript
// Added tracking variables
let updateInFlight = false;
let updateCpuInFlight = false;

// In both update() and updateCpu()
if (updateInFlight) {  // or updateCpuInFlight
    console.warn('Previous request still in flight, skipping');
    return;
}
updateInFlight = true;
```

**Benefits:**
- Prevents request stacking - max 1 request per endpoint at a time
- Skips new requests if previous one is still pending
- Logs warnings to console for debugging
- Clears flag in both success and error paths

---

### FIX #3: Improved Error Handling & Visibility
**Location:** bitcoin-dashboard.py:1778-1796, 2140-2144, 2146-2161, 2195-2219

**Changes:**
```javascript
// Added comprehensive error handling in updateCpu()
.catch(e => {
    clearTimeout(timeoutId);
    updateCpuInFlight = false;

    backendHealth.consecutiveFailures++;
    if (backendHealth.consecutiveFailures >= 3) {
        backendHealth.isHealthy = false;
    }

    const errMsg = e.name === 'AbortError' ? 'System stats timeout' : 'System stats error';
    console.error('updateCpu error:', errMsg, e);

    // Show visual feedback
    if (backendHealth.consecutiveFailures >= 3) {
        document.getElementById('statusText').textContent = 'Backend Unhealthy';
        document.getElementById('statusDot').className = 'status-dot status-error';
    }
});

// Added stale data detection
const dataAge = (Date.now() - lastFetchTime) / 1000;
if (dataAge > settings.blockRefresh * 2) {
    console.warn('Data appears stale, age:', dataAge.toFixed(0), 'seconds');
}

// Added periodic backend health check
function checkBackendHealth() {
    const timeSinceSuccess = (now - backendHealth.lastSuccessTime) / 1000;
    if (timeSinceSuccess > 120) {
        console.warn('Backend unhealthy - no successful requests for', timeSinceSuccess.toFixed(0), 'seconds');
        if (backendHealth.consecutiveFailures >= 5) {
            document.getElementById('statusText').textContent = 'Backend Disconnected';
        } else if (backendHealth.consecutiveFailures >= 3) {
            document.getElementById('statusText').textContent = 'Backend Degraded';
        }
    }
}
setInterval(checkBackendHealth, 30000);  // Check every 30 seconds
```

**Benefits:**
- User sees clear error states: "Backend Unhealthy", "Backend Degraded", "Backend Disconnected"
- Console logs show detailed error information for debugging
- Detects and warns about stale data
- Periodic health checks catch slow degradation

---

### FIX #4: Backend Health Tracking
**Location:** bitcoin-dashboard.py:1491-1496, 1758-1762, 1782-1786, 1869-1873, 2151-2155

**Changes:**
```javascript
// Added health tracking state
let backendHealth = {
    consecutiveFailures: 0,
    lastSuccessTime: Date.now(),
    isHealthy: true
};

// On successful requests
backendHealth.consecutiveFailures = 0;
backendHealth.lastSuccessTime = Date.now();
backendHealth.isHealthy = true;

// On failed requests
backendHealth.consecutiveFailures++;
if (backendHealth.consecutiveFailures >= 3) {
    backendHealth.isHealthy = false;
}

// Console logs include failure count
console.error('API fetch error:', e, '| Consecutive failures:', backendHealth.consecutiveFailures);
```

**Benefits:**
- Tracks consecutive failures to detect sustained issues
- Distinguishes between transient errors and real problems
- 3 failures = "Backend Unhealthy"
- 5 failures = "Backend Disconnected"
- Resets on first successful request

---

### FIX #5: Clear Expired Cache on Backend Failure
**Location:** bitcoin-dashboard.py:79-95, 641-643, 324-327, 570-573, 750-752

**Changes:**
```python
# Added cache expiration helper function
def clear_expired_cache(cache_name, max_age=300):
    """Clear cache if data is older than max_age seconds (default 5 minutes)"""
    if cache_name not in timed_cache:
        return
    cache = timed_cache[cache_name]
    now = time.time()
    age = now - cache['last_update']
    # If data is older than max_age, clear it
    if age > max_age:
        if 'data' in cache:
            cache['data'] = None
        if 'value' in cache:
            cache['value'] = 0
        cache['last_update'] = 0
        print(f"Cleared stale cache '{cache_name}' (age: {age:.0f}s)")

# Applied to all RPC call sites
chainstates = run_bitcoin_cli("getchainstates")
if not chainstates:
    clear_expired_cache('blockchain', max_age=300)

mempool = run_bitcoin_cli("getmempoolinfo")
if not mempool:
    clear_expired_cache('mempool', max_age=180)

blockhash = run_bitcoin_cli("getbestblockhash")
if not blockhash:
    clear_expired_cache('latest_block', max_age=180)

peerinfo = run_bitcoin_cli("getconnectioncount")
if not peerinfo:
    clear_expired_cache('connections', max_age=180)
```

**Benefits:**
- Prevents serving indefinitely stale data
- Clears cache after 3-5 minutes of no updates
- Logs cache clearing for debugging
- Returns empty data instead of old data once expired

---

## Testing & Verification

### Syntax Check
âœ“ Python syntax validated with `python3 -m py_compile bitcoin-dashboard.py`

### Before Deploying
1. **Backup current version:**
   ```bash
   cp bitcoin-dashboard.py bitcoin-dashboard.py.backup-2026-02-03
   ```

2. **Test locally first:**
   ```bash
   python3 bitcoin-dashboard.py --host localhost --port 8891
   # Open http://localhost:8891 in browser
   # Open browser console (F12) to see debug logs
   ```

3. **Check console logs:**
   - Should see: "Cleared stale cache..." messages if RPC fails
   - Should see: "Previous request still in flight, skipping" if requests stack
   - Should see: "Consecutive failures: N" in error logs
   - Should see: "Backend unhealthy" warnings if backend degrades

4. **Simulate failure to test:**
   ```bash
   # Stop bitcoind temporarily to test error handling
   sudo systemctl stop bitcoind
   # Watch dashboard - should show "Backend Unhealthy" after 3 failures
   # Check console for error messages
   # Restart bitcoind
   sudo systemctl start bitcoind
   # Dashboard should recover and show "Syncing..." or "Synced"
   ```

5. **Deploy to production:**
   ```bash
   sudo systemctl restart bitcoin-dashboard
   sudo systemctl status bitcoin-dashboard
   ```

### Monitoring After Deploy
- Check logs: `sudo journalctl -u bitcoin-dashboard -f`
- Watch for "Cleared stale cache" messages
- Verify no "request still in flight" warnings in normal operation
- Confirm dashboard stays responsive during long RPC calls

---

## Expected Behavior Changes

### Before Fixes
- Dashboard gradually became unresponsive over hours
- Data became stale with no indication
- Browser accumulated pending requests
- System resources exhausted (file descriptors, processes)
- Silent failures with empty catch blocks
- No user feedback when backend degraded

### After Fixes
- Maximum 1 request per endpoint at a time (no stacking)
- Requests timeout after 15 seconds instead of hanging
- Stale cache cleared after 5 minutes of no updates
- Clear visual feedback: "Backend Unhealthy", "Backend Degraded", "Backend Disconnected"
- Console logs show detailed error information
- Backend health tracked with consecutive failure count
- Periodic health checks every 30 seconds
- Dashboard recovers automatically when backend comes back

---

## Additional Notes

### No Connection Pooling Yet
The subprocess/SSH connection issue is mitigated by request-in-flight tracking, but not fully solved. A future enhancement could add:
- SSH connection pooling using `paramiko` library
- Persistent subprocess with stdin/stdout pipes
- Connection reuse for multiple RPC calls

For now, the fixes prevent request stacking, which was the critical issue causing resource exhaustion.

### Performance Impact
- Minimal - added checks are lightweight
- Request-in-flight flags are simple boolean checks
- Health tracking updates simple counters
- Cache clearing only happens on failures

### Compatibility
- No breaking changes to API or data formats
- Frontend changes are backwards compatible
- Settings unchanged (blockRefresh, cpuRefresh work as before)
- All existing features preserved

---

## Rollback Procedure

If issues occur after deployment:

1. **Quick rollback:**
   ```bash
   sudo systemctl stop bitcoin-dashboard
   cp bitcoin-dashboard.py.backup-2026-02-03 bitcoin-dashboard.py
   sudo systemctl start bitcoin-dashboard
   ```

2. **Check what went wrong:**
   ```bash
   sudo journalctl -u bitcoin-dashboard -n 100
   ```

3. **Report issues:**
   - Include console log output (browser F12)
   - Include systemd journal logs
   - Describe observed behavior

---

## Files Modified
- `bitcoin-dashboard.py` - Main application file (all fixes)

## Files Created
- `FIXES-2026-02-03.md` - This document

## Next Steps
1. Test in development (port 8891)
2. Simulate failures to verify error handling
3. Deploy to production (port 8890)
4. Monitor for 24-48 hours
5. Verify no degradation over time
